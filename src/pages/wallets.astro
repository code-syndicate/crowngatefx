---
import config from "../config";
import Layout from "../layouts/Layout.astro";
import { checkAuth } from "../lib/checkauth";
import Footer from "../components/Footer";
import Prices from "../components/Prices";
import TransactionTable from "../components/TransactionHistory";
import { MdMoney } from "react-icons/md";
import WCard from "../components/WCard";

export const prerender = false;

if (!Astro.cookies.has(config.authCookieKey)) {
  return Astro.redirect("/sign-in");
}

const authUser = Astro.cookies.get(config.authCookieKey).value;

const isAuth = await checkAuth({
  email: authUser,
});

if (!isAuth) {
  return Astro.redirect("/sign-in");
}

const account = isAuth.user.account;
---

<Layout title={config.appName}>
  <div class="min-h-screen">
    <!-- Mobile App-like Header -->
    <div class="lg:hidden bg-surface/50 backdrop-blur-xl sticky top-0 z-40 px-5 py-4 border-b border-white/5">
      <p class="text-text2 text-xs uppercase tracking-widest font-bold">Wallet</p>
      <h1 class="text-xl font-bold text-white tracking-tight">Your Assets</h1>
    </div>

    <!-- Desktop Header -->
    <div class="hidden lg:block px-8 pt-8 max-w-7xl mx-auto">
      <h1 class="text-3xl font-bold text-white tracking-tight">Wallet Overview</h1>
      <p class="text-text2 mt-1">Manage your assets and track transactions.</p>
    </div>

    <!-- Main Content -->
    <div class="px-4 lg:px-8 py-6 max-w-7xl mx-auto space-y-6">
      
      <!-- Quick Stats - Horizontal scroll on mobile -->
      <div class="flex gap-4 overflow-x-auto pb-2 -mx-4 px-4 lg:mx-0 lg:px-0 lg:grid lg:grid-cols-3 scrollbar-hide">
        <div class="card-nebula p-5 min-w-[180px] lg:min-w-0 flex-shrink-0">
          <p class="text-text2 text-xs font-bold uppercase tracking-wider mb-2">Total Balance</p>
          <p class="text-2xl font-bold text-white font-mono">${account.balance + account.bonus}</p>
        </div>

        <div class="card-glow p-5 min-w-[180px] lg:min-w-0 flex-shrink-0">
          <p class="text-text2 text-xs font-bold uppercase tracking-wider mb-2">Total Withdrawals</p>
          <p class="text-2xl font-bold text-white font-mono">${account.withdrawals}</p>
        </div>

        <div class="card-glow p-5 min-w-[180px] lg:min-w-0 flex-shrink-0">
          <p class="text-text2 text-xs font-bold uppercase tracking-wider mb-2">Total Deposits</p>
          <p class="text-2xl font-bold text-white font-mono">${account.deposits}</p>
        </div>
      </div>

      <!-- Withdraw Action -->
      <div class="card-nebula p-5">
        <WCard client:load account={account} />
      </div>

      <!-- Coin Balances Section -->
      <div>
        <h4 class="text-base lg:text-lg font-bold text-white mb-4">
          Coin Balances
        </h4>
        <Prices client:load auth={isAuth} />
      </div>

      <!-- Transaction History -->
      <div>
        <h4 class="text-base lg:text-lg font-bold text-white mb-4">
          Transaction History
        </h4>
        <TransactionTable user={isAuth.user} />
      </div>
    </div>

    <Footer />
  </div>
</Layout>
