---
import config from "../config";
import Layout from "../layouts/Layout.astro";
import { checkAuth } from "../lib/checkauth";
import Footer from "../components/Footer";
import Prices from "../components/Prices";

export const prerender = false;

if (!Astro.cookies.has(config.authCookieKey)) {
  return Astro.redirect("/sign-in");
}

const authUser = Astro.cookies.get(config.authCookieKey).value;

const isAuth = await checkAuth({
  email: authUser,
});

if (!isAuth) {
  return Astro.redirect("/sign-in");
}
---

<Layout title={config.appName}>
  <div class="min-h-screen">
    <!-- Mobile App-like Header -->
    <div class="lg:hidden bg-surface/50 backdrop-blur-xl sticky top-0 z-40 px-5 py-4 border-b border-white/5">
      <p class="text-text2 text-xs uppercase tracking-widest font-bold">Exchange</p>
      <h1 class="text-xl font-bold text-white tracking-tight">Trade & Markets</h1>
    </div>

    <!-- Desktop Header -->
    <div class="hidden lg:block px-8 pt-4 max-w-7xl mx-auto">
      <h1 class="text-3xl font-bold text-white tracking-tight">Trade & Markets</h1>
      <p class="text-text2 mt-1">Monitor live prices and trade cryptocurrencies.</p>
    </div>

    <!-- Main Content -->
    <div class="px-4 lg:px-8 py-6 max-w-7xl mx-auto space-y-6">
      
      <!-- Bitcoin Widget -->
      <div class="card-nebula p-4 overflow-hidden">
        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
          <div class="tradingview-widget-container__widget"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-info.js" async>
          {
            "symbol": "BITSTAMP:BTCUSD",
            "width": "100%",
            "locale": "en",
            "colorTheme": "dark",
            "isTransparent": true
          }
          </script>
        </div>
        <!-- TradingView Widget END -->
      </div>

      <!-- Chart and Dominance Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Chart Widget -->
        <div class="lg:col-span-2 card-nebula p-4">
          <!-- TradingView Widget BEGIN -->
          <div class="tradingview-widget-container">
            <div id="tradingview_b3131"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
            new TradingView.widget({
              "autosize": false,
              "symbol": "BITSTAMP:BTCUSD",
              "interval": "D",
              "timezone": "Etc/UTC",
              "theme": "dark",
              "style": "9",
              "locale": "en",
              "enable_publishing": false,
              "allow_symbol_change": true,
              "container_id": "tradingview_b3131",
              "width": "100%",
              "height": "350"
            });
            </script>
          </div>
          <!-- TradingView Widget END -->
        </div>

        <!-- Dominance Widget -->
        <div class="card-glow p-4 flex items-center justify-center">
          <script async src="https://static.coinstats.app/widgets/insights-widget.js"></script>
          <coin-stats-insight-widget 
            type="dominance" 
            bg-color="#212B39" 
            text-color="#FFFFFF" 
            chart-primary-color="#3b82f6" 
            chart-secondary-color="#1d4ed8" 
            button-color="#3b82f6" 
            border-color="rgba(255,255,255,0.1)" 
            font="Roboto, Arial, Helvetica" 
            coin-id="bitcoin">
          </coin-stats-insight-widget>
        </div>
      </div>

      <!-- Screener Widget -->
      <div class="card-nebula p-4 overflow-hidden">
        <h3 class="text-lg font-bold text-white mb-4">Market Overview</h3>
        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
          <div class="tradingview-widget-container__widget"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-screener.js" async>
          {
            "width": "100%",
            "height": "300",
            "autoSize": false,
            "defaultColumn": "overview",
            "screener_type": "crypto_mkt",
            "displayCurrency": "USD",
            "colorTheme": "dark",
            "locale": "en",
            "isTransparent": true
          }
          </script>
        </div>
        <!-- TradingView Widget END -->
      </div>

      <!-- Market Quotes Widget -->
      <div class="card-nebula p-4 overflow-hidden">
        <h3 class="text-lg font-bold text-white mb-4">Market Quotes</h3>
        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
          <div class="tradingview-widget-container__widget"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-quotes.js" async>
          {
            "width": "100%",
            "height": 350,
            "autoSize": false,
            "symbolsGroups": [
              {
                "name": "Crypto",
                "symbols": [
                  { "name": "BITSTAMP:BTCUSD", "displayName": "Bitcoin" },
                  { "name": "BITSTAMP:ETHUSD", "displayName": "Ethereum" },
                  { "name": "BINANCE:BNBUSDT", "displayName": "BNB" },
                  { "name": "BINANCE:SOLUSDT", "displayName": "Solana" }
                ]
              },
              {
                "name": "Forex",
                "symbols": [
                  { "name": "FX:EURUSD", "displayName": "EUR/USD" },
                  { "name": "FX:GBPUSD", "displayName": "GBP/USD" },
                  { "name": "FX:USDJPY", "displayName": "USD/JPY" }
                ]
              }
            ],
            "showSymbolLogo": true,
            "colorTheme": "dark",
            "isTransparent": true,
            "locale": "en"
          }
          </script>
        </div>
        <!-- TradingView Widget END -->
      </div>
    </div>

    <Footer />
  </div>
</Layout>
